<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AJA NTV2 SDK: The KONA XM™ Supplement</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../ajastyles.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../AJALogoMini.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AJA NTV2 SDK
   &#160;<span id="projectnumber">17.5.0.1521</span>
   </div>
   <div id="projectbrief">NTV2 SDK 17.5.0.1521</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('d7/dfa/xmsupplement.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">The KONA XM™ Supplement </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="xmoverview"></a>
Overview</h1>
<p>This document discusses special considerations when working with the <a class="el" href="../../d0/d53/ntv2devices.html#konaxm">KONA XM™</a> device when flashed with the special “XM” firmware that supports multiple, continuous asynchronous DMA transfers.</p>
<p>As of SDK 17.5, only the Linux NTV2 kernel driver supports CNTV2Card’s streaming DMA APIs.</p>
<p>The SDK provides two demonstration programs that utilize the streaming DMA APIs:</p><ul>
<li><a class="el" href="../../d9/d07/demoapps.html#ntv2streamplayer">NTV2StreamPlayer Demo</a> — a simple video-only player;</li>
<li>ntv2streampreview — a Qt-based GUI program that captures and displays incoming video.</li>
</ul>
<h1><a class="anchor" id="xmhwinstall"></a>
Installing the Hardware</h1>
<p>The <a class="el" href="../../d0/d53/ntv2devices.html#konaxm">KONA XM™</a> must be installed in appropriate PCIe slots. The minimum requirements are a PCI Express Gen3 × 4 lane slot.</p>
<p>The card can operate with PCIe bus power when inserted into a 25-watt slot, or on external power via its ATX 6-Pin connector located on the back of the card. It automatically switches to external power when it’s connected and available.</p>
<h2><a class="anchor" id="xmfirmware"></a>
Obtaining &amp; Installing KONA XM Firmware</h2>
<p>The KONA XM firmware can be downloaded from here:<br  />
 <a href="https://github.com/aja-video/ntv2-firmware/blob/github-mirror/konax/konaxm.bit">https://github.com/aja-video/ntv2-firmware/blob/github-mirror/konax/konaxm.bit</a></p>
<p>To install the firmware, follow the <a class="el" href="../../d1/dc5/ntv2devops.html#devfw-flash">“Flashing” Firmware</a> instructions.</p>
<h2><a class="anchor" id="xmdmaengines"></a>
DMA Engines</h2>
<p>The <a class="el" href="../../d0/d53/ntv2devices.html#konaxm">KONA XM™</a> firmware implements streaming DMA engines instead of the block mode engines used in other AJA devices and the <a class="el" href="../../d0/d53/ntv2devices.html#konax">KONA X™</a>.</p>
<p>In current designs, all the DMA engines are either block mode or streaming — not mixed — but this may change in the future.</p>
<dl class="section note"><dt>Note</dt><dd>Streaming currently only works with video. Thus <a class="el" href="../../d6/d0c/ntv2enums_8h.html#aaa90748f5a92082fa4f79c89698d9463a822697a35e0230021779fe78471bebe7" title="See KONA XM™.">DEVICE_ID_KONAXM</a> cannot currently DMA audio or other ancillary data.</dd></dl>
<h1><a class="anchor" id="xmimplementation"></a>
Streaming APIs</h1>
<p>10 APIs were added to support konaxm:</p><ul>
<li><a class="el" href="../../d7/dfb/class_c_n_t_v2_card.html#a5aeba2e674cc10babd1ebeff2baa0ea7" title="Initialize a stream. Put the stream queue and hardware in a known good state ready for use....">CNTV2Card::StreamChannelInitialize</a> — Initializes the given FrameStore’s streaming DMA engine.</li>
<li><a class="el" href="../../d7/dfb/class_c_n_t_v2_card.html#aba3e7ac4ba5a90e9636f5e11bd59b4e0" title="Release a stream. Releases all buffers remaining in the queue.">CNTV2Card::StreamChannelRelease</a> — Releases all buffers remaining in the queue.</li>
<li><a class="el" href="../../d7/dfb/class_c_n_t_v2_card.html#adeef809b7948eb4bfeeba70d8e61d4ed" title="Start a stream. Put the stream is the active state to start processing queued buffers....">CNTV2Card::StreamChannelStart</a> — Starts the stream.</li>
<li><a class="el" href="../../d7/dfb/class_c_n_t_v2_card.html#a3cb56247831febcc134d7c675382bd0d" title="Stop a stream. Put the stream is the idle state. For frame based video, the stream will idle on the b...">CNTV2Card::StreamChannelStop</a> — Stops the stream.</li>
<li><a class="el" href="../../d7/dfb/class_c_n_t_v2_card.html#a3f99c25485f78951407a377f7e1fbe56" title="Flush a stream. Remove all the buffers from the stream except a currently active idle buffer....">CNTV2Card::StreamChannelFlush</a> — Flushes the stream, removing all buffers except the currently active idle buffer.</li>
<li><a class="el" href="../../d7/dfb/class_c_n_t_v2_card.html#a0d3c35c09cc3b3d9f0d96bb27bfdad1f" title="Get the current stream status.">CNTV2Card::StreamChannelStatus</a> — Gets the current stream status.</li>
<li><a class="el" href="../../d7/dfb/class_c_n_t_v2_card.html#a3f609310270252533eebba21c1772627" title="Wait for any stream event. Returns for any state or buffer change.">CNTV2Card::StreamChannelWait</a> — Efficiently waits for any change in the given stream.</li>
<li><a class="el" href="../../d7/dfb/class_c_n_t_v2_card.html#af6294def75ecda7ce1c00b7adc5eb95b" title="Queue a buffer to the stream. The bufferCookie is a user defined identifier of the buffer used by the...">CNTV2Card::StreamBufferQueue</a> — Adds a buffer to the stream’s buffer queue.</li>
<li><a class="el" href="../../d7/dfb/class_c_n_t_v2_card.html#acc2216e8c753635c4810216eff926425" title="Remove the oldest buffer released by the streaming engine from the buffer queue.">CNTV2Card::StreamBufferRelease</a> — Removes the oldest buffer released by the streaming DMA engine from the stream’s buffer queue.</li>
<li><a class="el" href="../../d7/dfb/class_c_n_t_v2_card.html#ac3e67ba2166179440a679a50bd7019b5" title="Get the status of the buffer identified by the bufferCookie.">CNTV2Card::StreamBufferStatus</a> — Gets the status of a given buffer.</li>
</ul>
<h2><a class="anchor" id="xmimpl-kernel"></a>
Kernel Driver</h2>
<p>Two new <b>NTV2Message</b>s were added to the NTV2 kernel driver to implement the new streaming functionality. The messages correspond to these user-space classes:</p><ul>
<li><a class="el" href="../../de/d67/class_n_t_v2_stream_channel.html">NTV2StreamChannel</a> — corresponds to <code>NTV2_TYPE_AJASTREAMCHANNEL</code> (<code>'stch'</code>) message;</li>
<li><a class="el" href="../../da/d92/class_n_t_v2_stream_buffer.html">NTV2StreamBuffer</a> — corresponds to <code>NTV2_TYPE_AJASTREAMBUFFER</code> (<code>'stbu'</code>) message.</li>
</ul>
<h1><a class="anchor" id="xmstrm"></a>
Streaming</h1>
<h2><a class="anchor" id="xmstrmcapture"></a>
Capture</h2>
<p>For capture, on all AJA devices except the <a class="el" href="../../d0/d53/ntv2devices.html#konaxm">KONA XM™</a>, traditional <a class="el" href="../../d9/d9a/recordplaytechniques.html#aboutautocirculate">AutoCirculate</a> DMA transfers frame raster data from device SDRAM to host memory in a single frame-sized chunk: </p><div class="image">
<img src="../../strm-capture-blockdma.png" alt=""/>
</div>
<p>In contrast, streaming mode captures directly to host memory: </p><div class="image">
<img src="../../strm-capture.png" alt=""/>
</div>
<ul>
<li>Each FrameStore has a corresponding streaming DMA engine with the same channel number as the FrameStore.</li>
<li>On <a class="el" href="../../d0/d53/ntv2devices.html#konaxm">KONA XM™</a>, channels 1 and 3 are playback engines, and channels 2 and 4 are capture engines.</li>
<li>Streaming DMA captures or plays video directly between host memory and the device crosspoint via the FrameStore.</li>
<li>Routing and video processing with <a class="el" href="../../d0/d53/ntv2devices.html#konaxm">KONA XM™</a> firmware is the same as <a class="el" href="../../d0/d53/ntv2devices.html#konax">KONA X™</a> firmware.</li>
<li>Since streaming DMA does not use device SDRAM, it therefore transfers continuously at the video pixel rate. This makes the synchronous <a class="el" href="../../d9/d9a/recordplaytechniques.html#aboutautocirculate">AutoCirculate</a> API impractical, so the streaming API uses a fully asynchronous design.</li>
<li>Host buffers delivered to the <a class="el" href="../../d9/d9a/recordplaytechniques.html#aboutautocirculate">AutoCirculate</a> API are used to transfer data immediately at full PCIe transfer speed.</li>
<li>Host buffers delivered to the streaming API are queued until the buffer is required by the streaming DMA engine, which operates at pixel rate, then released back to the application.</li>
<li>Streaming playback requires buffers to be queued before playback can begin.</li>
</ul>
<h2><a class="anchor" id="xmstrmplayback"></a>
Playback</h2>
<p>Streaming mode plays directly from host memory: </p><div class="image">
<img src="../../strm-playback.png" alt=""/>
</div>
<ul>
<li>Streaming mode playback requires transferring video to the device frame buffer before video playback can begin.</li>
<li>Host buffers are queued to the driver to be used for transfers as the playback proceeds, and the application is notified when the buffers are released. This is similar to <a class="el" href="../../d9/d9a/recordplaytechniques.html#aboutautocirculate">AutoCirculate</a> DMA.</li>
</ul>
<h2><a class="anchor" id="xmstrmdetails"></a>
Details</h2>
<ul>
<li>Streaming transfers are data agnostic.</li>
<li>The application decides the size of the buffers to be transferred by the streaming DMA engine. The buffers can be the size of an entire video frame, multiple video frames, or a “slice” (sub-frame portion) of a video frame.</li>
<li>The streaming DMA engine will start on the first video frame boundary following the call to <a class="el" href="../../d7/dfb/class_c_n_t_v2_card.html#adeef809b7948eb4bfeeba70d8e61d4ed" title="Start a stream. Put the stream is the active state to start processing queued buffers....">CNTV2Card::StreamChannelStart</a>.</li>
<li>When the streaming engine starves, it cycles (repeats) on the last buffer in the queue until it receives a new buffer.</li>
<li>Buffers must be locked (with the <b>map</b> flag) by the application before delivery to the streaming engine.</li>
</ul>
<h2><a class="anchor" id="xmstrmlatency"></a>
Latency</h2>
<ul>
<li>The streaming DMA engine has the potential to deliver captured video to the application at lower latency.</li>
<li>Currently <a class="el" href="../../d9/d9a/recordplaytechniques.html#aboutautocirculate">AutoCirculate</a> operates on video frames, and the capture latency is the time to capture the frame from the input to device SDRAM plus the DMA transfer time to host memory.</li>
<li>The streaming latency for frame-size transfers is simply the time to capture the video from the input, since the capture occurs directly to the host buffer.</li>
<li>The difference depends on the <a class="el" href="../../d9/d9a/recordplaytechniques.html#aboutautocirculate">AutoCirculate</a> DMA transfer time, which in most cases is much less than frame time.</li>
<li>The streaming API has a real advantage if the application can operate on slices of a frame.</li>
<li>Slices are delivered to host application memory as they arrive, and can be processed immediately without having to wait for the entire frame.</li>
</ul>
<h1><a class="anchor" id="xmstrmdemos"></a>
Streaming DMA Demos</h1>
<p>There are two new demo apps that demonstrate streaming DMA.</p>
<h2><a class="anchor" id="xmstrmplayer"></a>
NTV2StreamPlayer Demo</h2>
<p>The <a class="el" href="../../d9/d07/demoapps.html#ntv2streamplayer">NTV2StreamPlayer Demo</a> operates just like the <a class="el" href="../../d9/d07/demoapps.html#ntv2player">NTV2Player Demo</a> but uses the streaming API instead of the <a class="el" href="../../d9/d9a/recordplaytechniques.html#aboutautocirculate">AutoCirculate</a> API.</p>
<dl class="section note"><dt>Note</dt><dd>Streaming currently only supports video, so there is no audio or ancillary data.</dd></dl>
<ul>
<li>The significant changes are in the <a class="el" href="../../d1/d1e/class_n_t_v2_stream_player.html#a35d9cfcbcb042593625357678a672d9e" title="My consumer thread that repeatedly plays frames using AutoCirculate (until quit).">NTV2StreamPlayer::ConsumeFrames</a> function, which has the same organization as <a class="el" href="../../d9/d07/demoapps.html#ntv2player">NTV2Player Demo</a>.</li>
<li>The host buffers are prelocked then in a loop, then the current stream status is queried, buffers are queued to the stream from the circular list and released back to the circular list when their playout completes.</li>
</ul>
<h2><a class="anchor" id="xmstrmpreview"></a>
NTV2QtStreamPreview Demo</h2>
<p><a class="el" href="../../d9/d07/demoapps.html#ntv2qtstreampreview">NTV2QtStreamPreview Demo</a> operates just like <a class="el" href="../../d9/d07/demoapps.html#ntv2qtpreview">NTV2QtPreview Demo</a> but <a class="el" href="../../d0/df4/class_n_t_v2_frame_grabber.html" title="A QThread that captures audio/video from NTV2-compatible AJA devices and uses Qt signals to emit ARGB...">NTV2FrameGrabber</a> uses the streaming API instead of <a class="el" href="../../d9/d9a/recordplaytechniques.html#aboutautocirculate">AutoCirculate</a>.</p>
<ul>
<li>The significant changes are in the <a class="el" href="../../dc/d8d/class_n_t_v2_stream_grabber.html#a2dbe5116d77c9d9d0da6f3a568454bb7" title="My thread function.">NTV2StreamGrabber::run</a> function, which locks and pre-queues host buffers, then a loop waits for captured buffers to be released, displays their contents in the application window, and re-queues them to be filled again. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Thu Jan 23 2025 17:05:19 for AJA NTV2 SDK by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
